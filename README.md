视频目标检测截图工具

一、功能简介
本工具可对一个或多个视频文件进行目标检测（基于 YOLO 模型），自动截图指定类别的目标，并支持以下高级功能：

选择多个目标类别（如“车”、“人”、“狗”等）
设置关注区域（ROI）：只在指定区域内检测目标
移动目标检测：仅对首次出现或发生移动的目标截图
实时预览处理画面（带检测框和 ROI 显示）
自动跳帧处理（提升速度）
支持在截图上标注目标类别与置信度
支持中文路径与文件名

二、使用步骤
1. 准备工作
python 3.11+
确保已安装依赖
pip install ultralytics torch opencv-python pillow ttkbootstrap nvidia-ml-py  （注：torch安装CUDA版本才能使用英伟达显卡加速，要CU118+，显卡驱动522.06+）
将 YOLO 模型（如 yolo11x.pt）放入 ./models/ 目录（可修改 set.ini 指定路径）

2. 启动程序
python main.py

3. 设置使用参数
选择视频文件：支持多选
选择截图保存路径：确保有写入权限
目标类别：默认选中常见车辆类，可全选/取消
处理选项：
跳帧数：1=逐帧（慢），23=每23帧处理1帧（快）
置信度阈值：默认 0.1（越低越敏感）
✅ 只对移动目标截图：避免重复截图静止目标
✅ 在截图中标注目标：截图上显示类别和置信度
关注区域（ROI）：
点击“选取关注区域” → 在弹出窗口中左键点击画多边形（至少3点）
右键可删除最后一个点，完成后点“完成”
可随时点击“取消选取”清除 ROI

4. 开始处理
点击 【开始处理】
可随时 【暂停】 / 【继续】 / 【停止】
处理日志实时显示在下方
实时统计：FPS、截图总数、GPU 显存占用（如支持）

5. 查看结果
截图保存格式：
<视频文件名>_frame<帧号>_<目标类别>.jpg
例如：test_video_frame1285_小车.jpg

三、配置文件说明（set.ini）
配置项详解

1. model_path
类型：字符串
默认值：./models/yolo11x.pt
作用：指定 YOLO 模型文件路径。
说明：

支持相对路径或绝对路径。
模型需为 Ultralytics YOLO 格式（如 .pt 文件）。
若指定模型不存在，程序启动将报错。
✅ 建议：将常用模型放入 ./models/ 目录，如 yolo11n.pt（小模型快）、yolo11x.pt（大模型准）。

2. nms_iou_threshold
类型：浮点数（0.0 ~ 1.0）
默认值：0.45
作用：非极大值抑制（NMS）的 IoU 阈值。
说明：

用于抑制同一目标的重复检测框。
值越小，抑制越严格（保留更少重叠框）；值越大，保留更多重叠框。
通常 0.4~0.6 为合理范围。
✅ 调优建议：

重叠目标多（如密集人群）→ 降低至 0.3
目标分散 → 可提高至 0.5~0.6

3. inference_size
类型：整数（80倍数，建议 320~1280）
默认值：640
作用：模型推理时的输入图像分辨率（正方形）。
说明：

输入视频帧会缩放到此尺寸后送入模型。
分辨率越高，小目标检测越准，但速度越慢、显存占用越大。
程序自动限制在 [320, 1280] 范围内。
✅ 建议：

GPU 显存 < 6GB → 用 480 或 512
高精度需求（如车牌、小动物）→ 用 768 或 960
追求速度 → 用 320 或 416

4. batch_size
类型：整数（≥1）
默认值：8
作用：批量推理时每批处理的帧数。
说明：

仅在 GPU 模式下有效（CPU 强制设为 1）。
程序会根据 GPU 显存自动下调此值（安全机制）。
值越大，吞吐越高，但显存占用线性增长。
⚠️ 注意：即使设为 8，若显存不足，实际 batch 可能为 2 或 1。

5. roi_iou_threshold
类型：浮点数（0.0 ~ 1.0）
默认值：0.2
作用：判断“目标是否已在 ROI 中出现过”的 IoU 阈值。
说明：

用于“首次进入 ROI 才截图”逻辑。
若当前目标框与历史记录框的 IoU > 此值，则视为“已出现”，不再视为首次。
值越小，越容易重复截图；值越大，越严格。
✅ 建议：通常 0.2~0.4 合适。若目标移动慢，可适当提高。

6. movement_iou_threshold
类型：浮点数（0.0 ~ 1.0）
默认值：0.6
作用：判断目标是否“静止”的 IoU 阈值。
说明：

若当前框与前一帧框的 IoU > 此值 → 判定为“未移动”。
是移动检测的第一道过滤。

7. movement_relative_threshold
类型：浮点数（建议 0.01~0.1）
默认值：0.02
作用：目标中心点相对位移阈值（相对于目标尺寸）。
说明：

计算公式：相对位移 = 像素位移 / 目标平均宽高
若相对位移 > 此值 → 判定为“发生移动”。
可避免因目标大小不同导致的误判（大车移10像素 vs 小鸟移10像素）。
✅ 调优：

想捕捉微小移动 → 设为 0.01
过滤抖动 → 提高至 0.05

8. movement_consecutive_frames
类型：整数（≥1）
默认值：5
作用：连续多少帧检测到移动，才视为“真实移动”。
说明：

防止因单帧抖动或检测波动误触发截图。
值越大，越稳定，但可能漏掉短时移动。

9. movement_stable_seconds
类型：浮点数（秒）
默认值：5.0
作用：目标静止超过此时间后，若再次移动，则视为“新移动事件”。
说明：

用于避免“刚截图完就停住，再动又截图”的重复。
基于视频帧率估算时间（按 30fps 换算）。



四、注意事项
视频无法读取？请确认格式为 MP4、AVI 等 OpenCV 支持格式。
GPU 显存不足？程序会自动降低 batch_size，也可手动减小 inference_size。
截图太多？提高置信度阈值（如 0.5）或启用“只对移动目标截图”。
中文路径支持良好，但避免使用特殊符号（如 <>:"/\|?*）。
崩溃时会生成 logs/app_crash.log，请附上该文件反馈问题。
